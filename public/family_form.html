<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Event Form</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            text-align: center; /* Center align everything */
        }
        form { 
            max-width: 600px; 
            display: inline-block; /* Center the form within body */
        }
        .family-member { 
            border: 1px solid #ccc; 
            padding: 10px; 
            margin-bottom: 10px; 
            text-align: center; /* Center align family member section */
        }
        label { 
            display: inline-block; 
            width: 150px; 
            font-size: 18px; /* Increased font size */
        }
        input, textarea { 
            width: 250px; /* Increased box size */
            font-size: 18px; /* Increased font size */
        }
        textarea { 
            vertical-align: top; 
            height: 80px; /* Increased height for textarea */
        }
        button { 
            margin: 5px; 
            font-size: 18px; /* Increased font size */
        }
    </style>
</head>
<body>
    <h1>SRI GOPALAKRISHNA SWAMY TEMPLE, CHAMRAJ ESTATE</h1>
    <p>We offer Special Poojas on the occasions you cherish most, performed with devotion to invoke divine blessings of health, happiness, and prosperity for your family. For any queries, feel free to contact us at <strong>krishnatemplechamraj@gmail.com</strong>.</p>

    <form id="familyForm">
        <h2>Primary Details</h2>
        <label for="primaryName">Name:</label><input type="text" id="primaryName" required><br><br>
        <label for="primaryEmail">Email:</label><input type="email" id="primaryEmail" required><br><br>
        <label for="primaryDateOfEvent">Date of Event:</label><input type="date" id="primaryDateOfEvent" required><br><br>
        <label for="primaryEventDescription">Event Description:</label><textarea id="primaryEventDescription" required></textarea><br><br>
        <label for="primaryGotra">Gotra:</label><input type="text" id="primaryGotra" required><br><br>
        <label for="primaryNakshatra">Nakshatra:</label><input type="text" id="primaryNakshatra" required><br><br>
        <label for="primaryRashi">Rashi:</label><input type="text" id="primaryRashi" required><br><br>
        <label for="primaryPhone">Phone No.:</label><input type="tel" id="primaryPhone"><br><br>
        <label for="primaryAddress">Address:</label><textarea id="primaryAddress" required></textarea><br><br>
        <label for="familyMemberCount">No. of Family Members:</label><input type="number" id="familyMemberCount" min="0" max="12" value="0" oninput="updateFamilyForms()"><br><br>

        <h2>Family Members</h2>
        <div id="familyMembers"></div>

        <button type="submit">Submit</button>
    </form>

    <script>
        let memberCount = 0;

        function updateFamilyForms() {
            const count = parseInt(document.getElementById('familyMemberCount').value) || 0;
            if (count > 12) {
                alert('Max 12 family members');
                document.getElementById('familyMemberCount').value = 12;
                return;
            }
            const familyDiv = document.getElementById('familyMembers');
            familyDiv.innerHTML = '';
            memberCount = 0;
            for (let i = 0; i < count; i++) addFamilyMember(false);
        }

        function addFamilyMember(increment = true) {
            if (increment && memberCount >= 12) {
                alert('Max 12 family members');
                return;
            }
            if (increment) memberCount++;
            const div = document.createElement('div');
            div.className = 'family-member';
            div.innerHTML = `
                <h3>Member ${memberCount}</h3>
                <label for="name${memberCount}">Name:</label><input type="text" id="name${memberCount}" required><br><br>
                <label for="dateOfEvent${memberCount}">Date of Event:</label><input type="date" id="dateOfEvent${memberCount}" required><br><br>
                <label for="eventDescription${memberCount}">Event Description:</label><textarea id="eventDescription${memberCount}" required></textarea><br><br>
                <label for="gotra${memberCount}">Gotra:</label><input type="text" id="gotra${memberCount}" required><br><br>
                <label for="nakshatra${memberCount}">Nakshatra:</label><input type="text" id="nakshatra${memberCount}" required><br><br>
                <label for="rashi${memberCount}">Rashi:</label><input type="text" id="rashi${memberCount}" required><br><br>
                <label for="phone${memberCount}">Phone No.:</label><input type="tel" id="phone${memberCount}"><br><br>
                <label for="address${memberCount}">Address:</label><textarea id="address${memberCount}" required></textarea><br><br>
                <label for="relation${memberCount}">Relation:</label><input type="text" id="relation${memberCount}" required><br><br>
            `;
            document.getElementById('familyMembers').appendChild(div);
            if (increment) document.getElementById('familyMemberCount').value = memberCount;
        }

        document.getElementById('familyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const primary = {
                name: document.getElementById('primaryName').value,
                email: document.getElementById('primaryEmail').value,
                dateOfEvent: document.getElementById('primaryDateOfEvent').value,
                eventDescription: document.getElementById('primaryEventDescription').value,
                gotra: document.getElementById('primaryGotra').value,
                nakshatra: document.getElementById('primaryNakshatra').value,
                rashi: document.getElementById('primaryRashi').value,
                phone: document.getElementById('primaryPhone').value,
                address: document.getElementById('primaryAddress').value
            };
            const family = [];
            document.querySelectorAll('.family-member').forEach(m => {
                family.push({
                    name: m.querySelector(`input[id^="name"]`).value,
                    dateOfEvent: m.querySelector(`input[id^="dateOfEvent"]`).value,
                    eventDescription: m.querySelector(`textarea[id^="eventDescription"]`).value,
                    gotra: m.querySelector(`input[id^="gotra"]`).value,
                    nakshatra: m.querySelector(`input[id^="nakshatra"]`).value,
                    rashi: m.querySelector(`input[id^="rashi"]`).value,
                    phone: m.querySelector(`input[id^="phone"]`).value,
                    address: m.querySelector(`textarea[id^="address"]`).value,
                    relation: m.querySelector(`input[id^="relation"]`).value
                });
            });
            const familyMemberCount = parseInt(document.getElementById('familyMemberCount').value) || 0;

            if (!primary.email.includes('@') || !primary.dateOfEvent) {
                alert('Invalid email or date');
                return;
            }
            if (familyMemberCount > 12 || family.length !== familyMemberCount) {
                alert('Invalid family member count');
                return;
            }

            fetch(`/edit-count/${encodeURIComponent(primary.email)}`)
                .then(r => r.json())
                .then(d => {
                    if (d.editCount >= 3) {
                        alert('Edit limit reached');
                        return;
                    }
                    fetch('/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ primary, family, familyMemberCount })
                    }).then(r => r.json()).then(d => {
                        alert(d.message);
                        document.getElementById('familyForm').reset();
                        document.getElementById('familyMembers').innerHTML = '';
                        document.getElementById('familyMemberCount').value = 0;
                    }).catch(e => {
                        console.error('Submit error:', e);
                        alert('Error saving');
                    });
                }).catch(e => {
                    console.error('Edit count error:', e);
                    alert('Error checking edit count');
                });
        });
    </script>
</body>
</html>