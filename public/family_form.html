<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Event Details Form</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        form { max-width: 600px; }
        .family-member { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        label { display: inline-block; width: 150px; }
        input, textarea { width: 200px; }
        textarea { vertical-align: top; height: 60px; }
        button { margin: 5px; }
    </style>
</head>
<body>

<h1>Family Event Details Collection Form</h1>
<p>Enter your details as the primary submitter. Specify the number of family members (optional, up to 12) to add their details on their behalf, including their relation. Family members use your email. Data is saved to an Excel-compatible CSV file for admin access. You can edit a submission up to 3 times using the same email.</p>

<form id="familyForm">
    <h2>Primary Submitter Details</h2>
    <label for="primaryName">Name:</label>
    <input type="text" id="primaryName" required><br><br>
    
    <label for="primaryEmail">Email:</label>
    <input type="email" id="primaryEmail" required><br><br>
    
    <label for="primaryDateOfEvent">Date of Event:</label>
    <input type="date" id="primaryDateOfEvent" required><br><br>
    
    <label for="primaryEventDescription">Event Description:</label>
    <textarea id="primaryEventDescription" required></textarea><br><br>
    
    <label for="primaryGotra">Gotra:</label>
    <input type="text" id="primaryGotra" required><br><br>
    
    <label for="primaryNakshatra">Nakshatra:</label>
    <input type="text" id="primaryNakshatra" required><br><br>
    
    <label for="primaryRashi">Rashi:</label>
    <input type="text" id="primaryRashi" required><br><br>
    
    <label for="primaryPhone">Phone No.:</label>
    <input type="tel" id="primaryPhone"><br><br>
    
    <label for="primaryAddress">Address:</label>
    <textarea id="primaryAddress" required></textarea><br><br>
    
    <label for="familyMemberCount">No. of Family Members (optional):</label>
    <input type="number" id="familyMemberCount" min="0" max="12" value="0" oninput="updateFamilyMemberForms()"><br><br>
    
    <h2>Add Family Members</h2>
    <div id="familyMembers"></div>
    
    <button type="submit">Submit Form</button>
</form>

<script>
    let memberCount = 0;

    function updateFamilyMemberForms() {
        const familyMemberCount = parseInt(document.getElementById('familyMemberCount').value) || 0;
        if (familyMemberCount > 12) {
            alert('Maximum 12 family members allowed');
            document.getElementById('familyMemberCount').value = 12;
            return;
        }
        const familyMembersDiv = document.getElementById('familyMembers');
        familyMembersDiv.innerHTML = '';
        memberCount = 0;

        for (let i = 0; i < familyMemberCount; i++) {
            addFamilyMember(false);
        }
    }

    function addFamilyMember(incrementCount = true) {
        if (incrementCount && memberCount >= 12) {
            alert('Maximum 12 family members allowed');
            return;
        }
        if (incrementCount) {
            memberCount++;
        }
        const div = document.createElement('div');
        div.className = 'family-member';
        div.innerHTML = `
            <h3>Family Member ${memberCount}</h3>
            <label for="name${memberCount}">Name:</label>
            <input type="text" id="name${memberCount}" required><br><br>
            
            <label for="dateOfEvent${memberCount}">Date of Event:</label>
            <input type="date" id="dateOfEvent${memberCount}" required><br><br>
            
            <label for="eventDescription${memberCount}">Event Description:</label>
            <textarea id="eventDescription${memberCount}" required></textarea><br><br>
            
            <label for="gotra${memberCount}">Gotra:</label>
            <input type="text" id="gotra${memberCount}" required><br><br>
            
            <label for="nakshatra${memberCount}">Nakshatra:</label>
            <input type="text" id="nakshatra${memberCount}" required><br><br>
            
            <label for="rashi${memberCount}">Rashi:</label>
            <input type="text" id="rashi${memberCount}" required><br><br>
            
            <label for="phone${memberCount}">Phone No.:</label>
            <input type="tel" id="phone${memberCount}"><br><br>
            
            <label for="address${memberCount}">Address:</label>
            <textarea id="address${memberCount}" required></textarea><br><br>
            
            <label for="relation${memberCount}">Relation:</label>
            <input type="text" id="relation${memberCount}" required><br><br>
        `;
        document.getElementById('familyMembers').appendChild(div);
        if (incrementCount) {
            document.getElementById('familyMemberCount').value = memberCount;
        }
    }

    document.getElementById('familyForm').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const primary = {
            name: document.getElementById('primaryName').value,
            email: document.getElementById('primaryEmail').value,
            dateOfEvent: document.getElementById('primaryDateOfEvent').value,
            eventDescription: document.getElementById('primaryEventDescription').value,
            gotra: document.getElementById('primaryGotra').value,
            nakshatra: document.getElementById('primaryNakshatra').value,
            rashi: document.getElementById('primaryRashi').value,
            phone: document.getElementById('primaryPhone').value,
            address: document.getElementById('primaryAddress').value
        };
        
        const family = [];
        document.querySelectorAll('.family-member').forEach(member => {
            family.push({
                name: member.querySelector(`input[id^="name"]`).value,
                dateOfEvent: member.querySelector(`input[id^="dateOfEvent"]`).value,
                eventDescription: member.querySelector(`textarea[id^="eventDescription"]`).value,
                gotra: member.querySelector(`input[id^="gotra"]`).value,
                nakshatra: member.querySelector(`input[id^="nakshatra"]`).value,
                rashi: member.querySelector(`input[id^="rashi"]`).value,
                phone: member.querySelector(`input[id^="phone"]`).value,
                address: member.querySelector(`textarea[id^="address"]`).value,
                relation: member.querySelector(`input[id^="relation"]`).value
            });
        });
        
        const familyMemberCount = parseInt(document.getElementById('familyMemberCount').value) || 0;
        
        // Basic validation
        if (!primary.email.includes('@')) {
            alert('Invalid email format');
            return;
        }
        if (!primary.dateOfEvent) {
            alert('Please select a valid event date');
            return;
        }
        if (familyMemberCount > 12) {
            alert('Maximum 12 family members allowed');
            return;
        }
        if (family.length !== familyMemberCount) {
            alert(`Please add exactly ${familyMemberCount} family members`);
            return;
        }

        // Check edit count
        fetch(`/edit-count/${encodeURIComponent(primary.email)}`)
            .then(response => response.json())
            .then(data => {
                if (data.editCount >= 3) {
                    alert('Edit limit of 3 reached for this email');
                    return;
                }
                submitForm(primary, family, familyMemberCount);
            })
            .catch(error => {
                console.error('Error checking edit count:', error);
                alert('Error checking edit count');
            });
    });

    function submitForm(primary, family, familyMemberCount) {
        fetch('/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ primary, family, familyMemberCount })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            document.getElementById('familyForm').reset();
            document.getElementById('familyMembers').innerHTML = '';
            document.getElementById('familyMemberCount').value = 0;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving data');
        });
    }
</script>

</body>
</html>