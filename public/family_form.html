<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Puja Form</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f0f8ff;
            color: #1e3a8a;
            line-height: 1.5;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        header {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            color: #1e40af;
            padding: 25px 20px;
            text-align: center;
            border-bottom: 3px solid #60a5fa;
        }
        header h1 {
            margin: 0 0 12px;
            font-size: 1.8em;
            font-weight: 400;
            line-height: 1.3;
        }
        header p {
            margin: 0;
            font-size: 1em;
            line-height: 1.4;
        }
        header strong {
            font-weight: 600;
        }
        form {
            padding: 25px 20px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            font-size: 1.3em;
            font-weight: 600;
            color: #1e3a8a;
            margin: 0 0 20px;
            padding-bottom: 8px;
            border-bottom: 2px solid #bfdbfe;
        }
        .field-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e7ff;
            transition: all 0.2s ease;
        }
        .field-group:hover {
            background: #f1f5f9;
            border-color: #93c5fd;
        }
        .field-group label {
            font-size: 0.95em;
            color: #1e40af;
            font-weight: 600;
            margin: 0;
        }
        .field-group input,
        .field-group textarea {
            padding: 12px;
            border: 2px solid #e0f2fe;
            border-radius: 6px;
            font-size: 1em;
            transition: all 0.2s ease;
            background: white;
            width: 100%;
            box-sizing: border-box;
        }
        .field-group input:focus,
        .field-group textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
            background: #f8fafc;
        }
        .field-group textarea {
            min-height: 90px;
            resize: vertical;
        }
        button {
            display: block;
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            margin-top: 10px;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .dropdown-search {
            position: relative;
            width: 100%;
        }
        .dropdown-search input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0f2fe;
            border-radius: 6px;
            font-size: 1em;
            background: white;
            box-sizing: border-box;
        }
        .dropdown-search input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: #f8fafc;
        }
        .dropdown-search ul {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #93c5fd;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            z-index: 10000;
            display: none;
        }
        .dropdown-search ul.show {
            display: block;
        }
        .dropdown-search ul li {
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #e0f2fe;
            color: #1e40af;
        }
        .dropdown-search ul li:last-child {
            border-bottom: none;
        }
        .dropdown-search ul li:hover {
            background: #ecfdf5;
            color: #059669;
        }
        .family-member {
            background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
            border: 2px solid #d1fae5;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        .family-member h3 {
            font-size: 1.2em;
            font-weight: 600;
            color: #065f46;
            margin: 0 0 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #d1fae5;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .family-member h3::before {
            content: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
            font-size: 1.1em;
        }
        .family-member .field-group {
            background: white;
            border: 1px solid #d1fae5;
        }
        input[type="number"] {
            width: 80px;
            background: #ecfdf5;
            border-color: #d1fae5;
            color: #065f46;
            font-weight: 600;
            padding: 10px;
        }
        input[type="number"]:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            background: #f0fdf4;
        }
        .occasion-group {
            padding: 15px;
            background: #e6fffa;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #a7f3d0;
        }
        @media (min-width: 768px) {
            body { padding: 20px; }
            .field-group { flex-direction: row; align-items: center; }
            .field-group label { flex: 0 0 180px; text-align: right; margin-right: 15px; margin-top: 0; }
            .field-group input, .field-group textarea { flex: 1; max-width: none; }
            .dropdown-search ul { max-width: none; }
            .container { max-width: 900px; }
            header { padding: 30px 25px; }
            header h1 { font-size: 2em; }
            form { padding: 30px 25px; }
            .family-member { padding: 25px; }
        }
        @media (max-width: 480px) {
            body { padding: 10px; }
            header { padding: 20px 15px; }
            header h1 { font-size: 1.6em; }
            form { padding: 20px 15px; }
            .field-group { padding: 12px; }
            .family-member { padding: 15px; margin-bottom: 15px; }
            .family-member h3 { font-size: 1.1em; }
            input[type="number"] { width: 70px; }
            .dropdown-search ul { max-height: 180px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SRI GOPALAKRISHNA SWAMY TEMPLE, CHAMRAJ ESTATE</h1>
            <p>Greetings to all devotees,<br>
            We have made arrangements to perform Archana/Pooja for your important family occasions. Please fill in the details given below in the form.<br><br>
            If you are unable to attend in person, prasadams will be sent to you by post.<br>
            For any questions, kindly contact us at <strong>krishnatemplechamraj@gmail.com</strong></p>
        </header>

        <form id="familyForm">
            <div class="section">
                <h2>Primary Details</h2>
                <div class="field-group">
                    <label for="primaryName">Name:</label>
                    <input type="text" id="primaryName" required>
                </div>
                <div class="field-group">
                    <label for="primaryEmail">Email ID:</label>
                    <input type="email" id="primaryEmail" required>
                </div>
                <div class="field-group">
                    <label for="primaryPhone">Phone Number:</label>
                    <input type="tel" id="primaryPhone" required>
                </div>
                <div class="field-group">
                    <label for="primaryOccasionCount">No of Occasions (0-5):</label>
                    <input type="number" id="primaryOccasionCount" min="0" max="5" value="0" oninput="updatePrimaryOccasions()">
                </div>
                <div id="primaryOccasions"></div>
                <div class="field-group">
                    <label for="primaryGotra">Gotra:</label>
                    <div class="dropdown-search">
                        <input type="text" id="primaryGotra" onfocus="closeAllDropdowns(); showFullList('primaryGotra', gotraList)" onkeyup="filterOptions('primaryGotra', gotraList)">
                        <ul id="primaryGotraOptions"></ul>
                    </div>
                </div>
                <div class="field-group">
                    <label for="primaryNakshatra">Nakshatra:</label>
                    <div class="dropdown-search">
                        <input type="text" id="primaryNakshatra" onfocus="closeAllDropdowns(); showFullList('primaryNakshatra', nakshatraList)" onkeyup="filterOptions('primaryNakshatra', nakshatraList)">
                        <ul id="primaryNakshatraOptions"></ul>
                    </div>
                </div>
                <div class="field-group">
                    <label for="primaryTamilMonth">Tamil Month:</label>
                    <div class="dropdown-search">
                        <input type="text" id="primaryTamilMonth" onfocus="closeAllDropdowns(); showFullList('primaryTamilMonth', tamilMonthList)" onkeyup="filterOptions('primaryTamilMonth', tamilMonthList)">
                        <ul id="primaryTamilMonthOptions"></ul>
                    </div>
                </div>
                <div class="field-group">
                    <label for="primaryRashi">Rashi:</label>
                    <div class="dropdown-search">
                        <input type="text" id="primaryRashi" onfocus="closeAllDropdowns(); showFullList('primaryRashi', rashiList)" onkeyup="filterOptions('primaryRashi', rashiList)">
                        <ul id="primaryRashiOptions"></ul>
                    </div>
                </div>
                <div class="field-group">
                    <label for="primaryAddress">Address:</label>
                    <textarea id="primaryAddress" required></textarea>
                </div>
                <div class="field-group">
                    <label for="familyMemberCount">Add Family Members (0-12):</label>
                    <input type="number" id="familyMemberCount" min="0" max="12" value="0" oninput="updateFamilyForms()">
                </div>
            </div>

            <div class="section">
                <h2>Family Members</h2>
                <div id="familyMembers"></div>
            </div>

            <button type="submit">Submit</button>
        </form>
    </div>

    <script>
        let memberCount = 0;
        const occasionList = ["Birthday", "Wedding Anniversary"];
        const gotraList = ["Agastya", "Atri/Atreyasa", "Alambani", "Angad", "Angirasa", "Ahabhunasa", "Aupamanyava", "Babhravya", "Bharadwaj", "Bhargava", "Bhakdi", "Bhaskara", "Chandilya", "Charora", "Chikitasa", "Chyavana", "Dalabhya", "Darbhas", "Dev", "Dhananjaya", "Dhanvantari", "Galvasaya", "Garga", "Gautamasa", "Gaubhilya", "Ghrit-Kaushika", "Harita", "Hukman Bhal", "Jamadagni", "Jatukarna", "Kalabodhana", "Kamakayana Vishwamitra", "Kanva", "Kaushikasa", "Kapi", "Kapil", "Kapinjala", "Karmani", "Kashyapasa", "Kaundinyasa", "Kaunsh", "Kaushal", "Kaushik", "Kaustubha", "Kausyagasa", "Kavist", "Katyayana", "Krishnatreeya", "Kundina-Gowtama", "Kusha", "Kutsa", "Kutsasa", "Lakhi", "Lohit", "Lohita-Kowshika", "Lomasha", "Mandavya", "Marichi", "Markandeya", "Mauna Bhargava", "Matanga", "Mudgala", "Maudgalya", "Mihirayan", "Naidhruva", "Nithunthana", "Nyrdavakashyapa", "Nrisimhadevara", "Parashara", "Parthivasa", "Pouragutsya", "Punagashella", "Ratheetarasa", "Purang", "Pradnya", "Rathitara", "Rohinya", "Rauksaayana", "Saminathen", "Sanatana", "Salankayana", "Sangar", "Sanaka", "Sanaga", "Sanjaya", "Sankhyayana", "Sankrithi", "Sankyanasa", "Sathamarshana", "Shandilya", "Sandilyasa", "Shandelosya", "Saawarna", "Saharia Joshi", "Sauparna", "Savaran", "Savita", "Somnasser", "Pratanansya", "Saankritya", "Soral", "Srivasta", "Sumarkanth", "Suryadhwaja", "Shaktri", "Shaunaka", "Sravanvaitas", "Surya", "Swatantra Kabisa", "Tugnait", "Roushayadana", "Upadhyay", "Upamanyu", "Upreti", "Vadula", "Valmiki", "Vardhviyasa", "Vardhulasa", "Vardhyswasa", "Vashishta", "Vatsa", "Vatsyayan", "Veetahavya", "Vishnuvardhana", "Vishnuvruddha", "Valmiki", "Vishvagni", "Yaska", "Vaidya", "Vartantu", "Utsasya", "Suparna", "Shiva", "Kuvera"];
        const nakshatraList = ["Ashwini", "Bharani", "Karthigai", "Rohini", "Mrigasheersham", "Thiruvaathirai", "Punarpoosam", "Poosam", "Aayilyam", "Magham", "Pooram", "Uthiram", "Hastham", "Chithirai", "Swathi", "Vishakam", "Anusham", "Kettai", "Moolam", "Pooraadam", "Uthiraadam", "Thiruvonam", "Avittam", "Sadayam", "Poorattathi", "Uthirattathi", "Revathi"];
        const tamilMonthList = ["Chithirai", "Vaikasi", "Aani", "Aadi", "Avani", "Purattasi", "Aippasi", "Karthigai", "Thai", "Massi", "Panguni"];
        const rashiList = ["Mesham", "Vrishabham", "Mithunam", "Katakam", "Simmham", "Kanya", "Tula", "Vrishchikam", "Dhanur", "Makaram", "Kumbham", "Meenam"];

        function closeAllDropdowns(exceptId = null) {
            document.querySelectorAll('.dropdown-search ul').forEach(ul => {
                if (ul.id !== exceptId) ul.classList.remove('show');
            });
        }

        function showFullList(inputId, list) {
            closeAllDropdowns(inputId + 'Options');
            const input = document.getElementById(inputId);
            const ul = document.getElementById(inputId + 'Options');
            ul.innerHTML = '';
            list.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                li.onclick = () => {
                    input.value = item;
                    ul.classList.remove('show');
                };
                ul.appendChild(li);
            });
            ul.classList.add('show');
        }

        function filterOptions(inputId, list) {
            const input = document.getElementById(inputId);
            const ul = document.getElementById(inputId + 'Options');
            ul.innerHTML = '';
            const filter = input.value.toLowerCase();
            const filtered = list.filter(item => item.toLowerCase().includes(filter));
            filtered.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                li.onclick = () => {
                    input.value = item;
                    ul.classList.remove('show');
                };
                ul.appendChild(li);
            });
            ul.classList.toggle('show', filtered.length > 0);
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown-search')) {
                closeAllDropdowns();
            }
        });

        function updatePrimaryOccasions() {
            const count = parseInt(document.getElementById('primaryOccasionCount').value) || 0;
            if (count > 5) {
                alert('Max 5 occasions per person');
                document.getElementById('primaryOccasionCount').value = 5;
                return;
            }
            const occasionDiv = document.getElementById('primaryOccasions');
            occasionDiv.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                addPrimaryOccasion(i);
            }
        }

        function addPrimaryOccasion(occasionNumber) {
            const div = document.createElement('div');
            div.className = 'occasion-group';
            div.innerHTML = `
                <h4>Occasion ${occasionNumber}</h4>
                <div class="field-group">
                    <label for="primaryOccasion${occasionNumber}">Occasion Name:</label>
                    <div class="dropdown-search">
                        <input type="text" id="primaryOccasion${occasionNumber}" onfocus="closeAllDropdowns(); showFullList('primaryOccasion${occasionNumber}', occasionList)" onkeyup="filterOptions('primaryOccasion${occasionNumber}', occasionList)">
                        <ul id="primaryOccasion${occasionNumber}Options"></ul>
                    </div>
                </div>
                <div class="field-group">
                    <label for="primaryDateOfOccasion${occasionNumber}">Date of Occasion:</label>
                    <input type="date" id="primaryDateOfOccasion${occasionNumber}">
                </div>
            `;
            document.getElementById('primaryOccasions').appendChild(div);
        }

        function updateFamilyForms() {
            const count = parseInt(document.getElementById('familyMemberCount').value) || 0;
            if (count > 12) {
                alert('Max 12 family members');
                document.getElementById('familyMemberCount').value = 12;
                return;
            }
            const familyDiv = document.getElementById('familyMembers');
            familyDiv.innerHTML = '';
            memberCount = count;
            for (let i = 1; i <= count; i++) {
                addFamilyMember(i);
            }
        }

        function addFamilyMember(memberNumber) {
            const div = document.createElement('div');
            div.className = 'family-member';
            const primaryAddress = document.getElementById('primaryAddress').value;
            div.innerHTML = `
                <h3>Member ${memberNumber}</h3>
                <div class="field-group">
                    <label for="name${memberNumber}">Name:</label>
                    <input type="text" id="name${memberNumber}" required>
                </div>
                <div class="field-group">
                    <label for="phone${memberNumber}">Phone Number:</label>
                    <input type="tel" id="phone${memberNumber}" required>
                </div>
                <div class="field-group">
                    <label for="relation${memberNumber}">Relation:</label>
                    <input type="text" id="relation${memberNumber}">
                </div>
                <div class="field-group">
                    <label for="occasionCount${memberNumber}">No of Occasions (0-5):</label>
                    <input type="number" id="occasionCount${memberNumber}" min="0" max="5" value="0" oninput="updateFamilyOccasions(${memberNumber})">
                </div>
                <div id="occasions${memberNumber}"></div>
                <div class="field-group">
                    <label for="gotra${memberNumber}">Gotra:</label>
                    <div class="dropdown-search">
                        <input type="text" id="gotra${memberNumber}" onfocus="closeAllDropdowns(); showFullList('gotra${memberNumber}', gotraList)" onkeyup="filterOptions('gotra${memberNumber}', gotraList)">
                        <ul id="gotra${memberNumber}Options"></ul>
                    </div>
                </div>
                <div class="field-group">
                    <label for="nakshatra${memberNumber}">Nakshatra:</label>
                    <div class="dropdown-search">
                        <input type="text" id="nakshatra${memberNumber}" onfocus="closeAllDropdowns(); showFullList('nakshatra${memberNumber}', nakshatraList)" onkeyup="filterOptions('nakshatra${memberNumber}', nakshatraList)">
                        <ul id="nakshatra${memberNumber}Options"></ul>
                    </div>
                </div>
                <div class="field-group">
                    <label for="tamilMonth${memberNumber}">Tamil Month:</label>
                    <div class="dropdown-search">
                        <input type="text" id="tamilMonth${memberNumber}" onfocus="closeAllDropdowns(); showFullList('tamilMonth${memberNumber}', tamilMonthList)" onkeyup="filterOptions('tamilMonth${memberNumber}', tamilMonthList)">
                        <ul id="tamilMonth${memberNumber}Options"></ul>
                    </div>
                </div>
                <div class="field-group">
                    <label for="rashi${memberNumber}">Rashi:</label>
                    <div class="dropdown-search">
                        <input type="text" id="rashi${memberNumber}" onfocus="closeAllDropdowns(); showFullList('rashi${memberNumber}', rashiList)" onkeyup="filterOptions('rashi${memberNumber}', rashiList)">
                        <ul id="rashi${memberNumber}Options"></ul>
                    </div>
                </div>
                <div class="field-group">
                    <label for="address${memberNumber}">Address:</label>
                    <textarea id="address${memberNumber}" required>${primaryAddress}</textarea>
                </div>
            `;
            document.getElementById('familyMembers').appendChild(div);
        }

        function updateFamilyOccasions(memberNumber) {
            const count = parseInt(document.getElementById(`occasionCount${memberNumber}`).value) || 0;
            if (count > 5) {
                alert('Max 5 occasions per person');
                document.getElementById(`occasionCount${memberNumber}`).value = 5;
                return;
            }
            const occasionDiv = document.getElementById(`occasions${memberNumber}`);
            occasionDiv.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                addFamilyOccasion(memberNumber, i);
            }
        }

        function addFamilyOccasion(memberNumber, occasionNumber) {
            const div = document.createElement('div');
            div.className = 'occasion-group';
            div.innerHTML = `
                <h4>Occasion ${occasionNumber}</h4>
                <div class="field-group">
                    <label for="occasion${memberNumber}_${occasionNumber}">Occasion Name:</label>
                    <div class="dropdown-search">
                        <input type="text" id="occasion${memberNumber}_${occasionNumber}" onfocus="closeAllDropdowns(); showFullList('occasion${memberNumber}_${occasionNumber}', occasionList)" onkeyup="filterOptions('occasion${memberNumber}_${occasionNumber}', occasionList)">
                        <ul id="occasion${memberNumber}_${occasionNumber}Options"></ul>
                    </div>
                </div>
                <div class="field-group">
                    <label for="dateOfOccasion${memberNumber}_${occasionNumber}">Date of Occasion:</label>
                    <input type="date" id="dateOfOccasion${memberNumber}_${occasionNumber}">
                </div>
            `;
            document.getElementById(`occasions${memberNumber}`).appendChild(div);
        }

        document.getElementById('familyForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const primaryOccasionCount = parseInt(document.getElementById('primaryOccasionCount').value) || 0;
            const primary = {
                name: document.getElementById('primaryName').value,
                email: document.getElementById('primaryEmail').value,
                phone: document.getElementById('primaryPhone').value,
                address: document.getElementById('primaryAddress').value,
                gotra: document.getElementById('primaryGotra').value || '',
                nakshatra: document.getElementById('primaryNakshatra').value || '',
                tamilMonth: document.getElementById('primaryTamilMonth').value || '',
                rashi: document.getElementById('primaryRashi').value || ''
            };
            // Collect primary occasions as separate records
            const primaryRecords = [];
            if (primaryOccasionCount > 0) {
                for (let i = 1; i <= primaryOccasionCount; i++) {
                    const occasion = document.getElementById(`primaryOccasion${i}`).value || '';
                    const dateOfOccasion = document.getElementById(`primaryDateOfOccasion${i}`).value || '';
                    primaryRecords.push({
                        ...primary,
                        occasion,
                        dateOfOccasion,
                        relation: 'Self (Primary)'
                    });
                }
            } else {
                primaryRecords.push({
                    ...primary,
                    occasion: '',
                    dateOfOccasion: '',
                    relation: 'Self (Primary)'
                });
            }

            const family = [];
            for (let i = 1; i <= memberCount; i++) {
                const occasionCount = parseInt(document.getElementById(`occasionCount${i}`).value) || 0;
                const member = {
                    name: document.getElementById(`name${i}`).value,
                    phone: document.getElementById(`phone${i}`).value,
                    address: document.getElementById(`address${i}`).value,
                    relation: document.getElementById(`relation${i}`).value || `Family Member ${i}`,
                    gotra: document.getElementById(`gotra${i}`).value || '',
                    nakshatra: document.getElementById(`nakshatra${i}`).value || '',
                    tamilMonth: document.getElementById(`tamilMonth${i}`).value || '',
                    rashi: document.getElementById(`rashi${i}`).value || '',
                    email: primary.email // Use primary email for family
                };
                if (occasionCount > 0) {
                    for (let j = 1; j <= occasionCount; j++) {
                        const occasion = document.getElementById(`occasion${i}_${j}`).value || '';
                        const dateOfOccasion = document.getElementById(`dateOfOccasion${i}_${j}`).value || '';
                        family.push({
                            ...member,
                            occasion,
                            dateOfOccasion
                        });
                    }
                } else {
                    family.push({
                        ...member,
                        occasion: '',
                        dateOfOccasion: ''
                    });
                }
            }
            const familyMemberCount = parseInt(document.getElementById('familyMemberCount').value) || 0;

            if (!primary.email.includes('@')) {
                alert('Invalid email');
                return;
            }
            if (familyMemberCount > 12 || memberCount !== familyMemberCount) {
                alert('Invalid family member count');
                return;
            }
            if (primaryOccasionCount > 5 || family.some((_, idx) => {
                const m = Math.floor(idx / 5) + 1; // Approximate member index
                return parseInt(document.getElementById(`occasionCount${m}`).value) > 5;
            })) {
                alert('Max 5 occasions per person');
                return;
            }

            fetch(`/edit-count/${encodeURIComponent(primary.email)}`)
                .then(r => r.json())
                .then(d => {
                    if (d.editCount >= 3) {
                        alert('Edit limit reached');
                        return;
                    }
                    fetch('/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ primary: primaryRecords, family })
                    }).then(r => r.json()).then(d => {
                        if (d.message.includes('Error')) {
                            alert(d.message);
                        } else {
                            alert('Your response has been submitted!');
                            document.getElementById('familyForm').reset();
                            document.getElementById('primaryOccasions').innerHTML = '';
                            document.getElementById('familyMembers').innerHTML = '';
                            document.getElementById('familyMemberCount').value = 0;
                            document.getElementById('primaryOccasionCount').value = 0;
                            memberCount = 0;
                        }
                    }).catch(e => {
                        console.error('Submit error:', e);
                        alert('Error saving');
                    });
                }).catch(e => {
                    console.error('Edit count error:', e);
                    alert('Error checking edit count');
                });
        });
    </script>
</body>
</html>